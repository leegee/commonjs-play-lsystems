<!DOCTYPE html>
 
<html>
	<head>
		<title>L-systems in HTML5</title>
		<meta charset="utf-8">

		<script type="text/javascript" src="/js/log4javascript/log4javascript.js"></script>

		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/mootools/1.4/mootools-yui-compressed.js"></script>

		<script src='/MooKnob/Mootools-Knob/Source/Knob.js'></script>

		<script src="js/LsysParametric.js"></script>
		<link rel="stylesheet" href="css/lsys.css" type="text/css" media="all" />

		<script type='text/javascript'>
			"use strict";

			// var LOGGER = log4javascript.getLogger();
			var LOGGER = log4javascript.getDefaultLogger();
			/*
			var appender = new log4javascript.BrowserConsoleAppender();
			// var popUpLayout = new log4javascript.PatternLayout("%d{HH:mm:ss} %-5p - %m%n");
			// appender.setLayout(popUpLayout);
			 appender.setThreshold(log4javascript.Level.INFO);
			 LOGGER.addAppender(appender);
			*/

			function playSound(audioURL) {
				if (document.all) document.all['BGSOUND_ID'].src=audioURL;
			 	else $('iplayer').set('src', 'jsplayer.html?'+audioURL);
			}

			var presets = [
				{ // list all, even unused, keys on this first eleemnt
					title			: 'Parametric test',
					variables		:	"#define $W	0.5\n" +
										"#define $AS  2\n" +
										"#define $BS  1\n" +
										"#define $R 	  1\n" +
										"#define $L	 -1",
					rules			:
						"F($s,$o) : $s == $AS && $o == $R -> F($AS,$L)F($BS,$R)\n" +
						"F($s,$o) : $s == $AS && $o == $L -> F($BS,$L)F($AS,$R)\n" +
						"F($s,$o) : $s == $BS	             -> F($AS,$o)\n",
					start			: "!($W)F($BS,$R)",
					angle			: 22,
					init_x			: 0,
					init_y			: 0,
					canvas_width	: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 4,
					turtle_step_y	: 4,
					generations		: 4,
					line_width		: 4
				},

				{ // list all, even unused, keys on this first eleemnt
					title			: 'Tree 1',
					variables		: '',
					rules			: 'F->C0FF-[C1-F+F+F]+[C2+F-F-F]',
					start			: 'F',
					angle			: 22,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 4,
					turtle_step_y	: 4,
					generations		: 5,
					line_width		: 1,
					wrap_angle_at	: 12
				},
				{
					title			: 'Tree x',
					variables		: '',
					rules			: "X->C0F-[C2[X]+C3X]+C1F[C3+FX]-X\nF->FF",
					start			: 'X',
					angle			: 27,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 8,
					turtle_step_y	: 8,
					generations		: 6,
					line_width		: 3,
					wrap_angle_at	: 12
				},
				{
					title			: 'Tree x',
					variables		: '',
					rules			: "X->C0F-[C2[X]+C3X]+C1F[C3+FX]-X\nF->FF",
					start			: 'X',
					angle			: 27,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 8,
					turtle_step_y	: 8,
					generations		: 6,
					line_width		: 3,
					wrap_angle_at	: 12
				},
				{
					title			: 'Sierpinski Median Curve (2 gens)',
					variables		: '',
					rules			: "L->+R-F-R+\nR->-L+F+L-",
					start			: 'L--F--L--F',
					angle			: 45,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 10,
					turtle_step_y	: 10,
					generations		: 2,
					line_width		: 3,
					wrap_angle_at	: 12
				},
				{
					title			: 'Sierpinski Median Curve (4 gens)',
					variables		: '',
					rules			: "L->+R-F-R+\nR->-L+F+L-",
					start			: 'L--F--L--F',
					angle			: 45,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 10,
					turtle_step_y	: 10,
					generations		: 4,
					line_width		: 3,
					wrap_angle_at	: 12
				},
				{
					title			: 'Koch Snowflake',
					variables		: '',
					rules			: "F->F-F++F-F\nX->FF",
					start			: 'F++F++F',
					angle			: 60,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 4,
					turtle_step_y	: 4,
					generations		: 4,
					line_width		: 6,
					wrap_angle_at	: 12
				},
				{
					title			: 'Tree 3',
					variables		: '',
					rules			: 'F -> FF-[-F+F]+[+F-F]',
					start			: 'F',
					angle			: 22,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 4,
					turtle_step_y	: 4,
					generations		: 5,
					wrap_angle_at	: 12
				},
				{
					title			: 'Tree 4',
					variables		: '',
					rules			: "F -> F[-FF]F[+FF]F",
					start			: 'F',
					angle			: 22,
					init_x			: 0,
					init_y			: 0,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 4,
					turtle_step_y	: 4,
					generations		: 5,
					wrap_angle_at	: 12
				},
				{
					title			: 'Dragon Curve',
					variables		: '',
					rules			: "X->X+YF\nY->FX-Y",
					start			: 'FX',
					angle			: 90,
					init_x			: 800,
					init_y			: 100,
					canvas_width		: 1000,
					canvas_height	: 1000,
					turtle_step_x	: 5,
					turtle_step_y	: 5,
					generations		: 7,
					line_width		: 8,
					wrap_angle_at	: 12
				}
			];

			function preview(){
				$('preview').empty();
				var options = {};
				var override = {
					canvas_width: 200,
					canvas_height: 100,
					el:	$('preview')
				};
				Object.keys(presets[0]).each( function(i){
					options[i] = $(i).value;
				});
				for (var i in override){
					options[i] = override[i];
				}
				var lsys = new Lsys(options);
				lsys.generate( 1 );
				createMIDIonServer(lsys, 'preview');
			}

			function loadPreset( idx ){
				Object.keys(presets[idx]).each( function(i){
					try {
						$(i).set('value', presets[idx][i]);
					} catch(e){
						alert('Could not set '+i+'.value');
					}
				});
				$('title').set('text', presets[idx].title);
				preview();
			}

			function createMIDIonServer(lsys, isPreview){
				if (!lsys || !lsys.hasOwnProperty('content')) {
					alert('Graph first, please');
					return
				}
				try {
					new Request.JSON({
						url: '/cgi-bin/fractal_plant_chords.cgi',
						onFailure: function(e){
							alert('Not available from your IP');
							console.log(e);
						},
						onComplete: function(){
							createMidi.set('value', 'Geneate MIDI');
							createMidi.set('disabled', false);
						},
						onError: function(e){
							$('error').set('text', e);
							console.error(e);
							// playSound( "/cgi-output/cgi.midi" );
						},
						onSuccess: function(res){
							$('error').set('text', res.errors);
							if (!res.errors){
								playSound( "/cgi-output/cgi.midi" );
							}
						}
					}).post({
						content: lsys.content,
						isPreview: isPreview,
						duration: $('duration').value,
						angle: $('angle').value,
						scale: $('scale').value,
						wrap_angle_at: $('wrap_angle_at').value,
						bracket_callback: $('bracket_callback').value
					})
				}
				catch (e){
					console.error( e );
				}
			}

			document.addEvent('domready', function(){
				function listPresets(){
					var ul = $('presets');
					presets.each( function(i,j){
						ul.adopt(
							new Element('li', {
								text: i.title,
								id: 'preset_'+j,
								events: { click: function(e){
									loadPreset( e.target.id.substr(7) );
								}}
							})
						);
					});
				}

				var midi = $('midi');
				var createMidi = $('createMidi');
				var generate = $('generate');
				var el_canvases = $('canvases');
				var contentDisplay = $('contentDisplay');
				var lsys = null;

				listPresets();
				loadPreset(0);

				generate.addEvent('click', function(e){
					generate.set('value','Generating...');
					generate.set('disabled', true);
					createMidi.set('disabled', true);

					var options = {};
					Object.keys(presets[0]).each( function(i){
						options[i] = $(i).value;
					});

					var display_rules = $('rules').value;
					display_rules = display_rules.replace(/->/g, '→');
					var el_t = new Element('div', {
						'class':'timing',
						text: new Date().getTime()
					});
					el_canvases.adopt(el_t);
					options.el = el_canvases;

					lsys = new Lsys(options);
					lsys.generate( options.generations );

					el_t.set('text', 'Generated in '+
						(new Date().getTime() - (el_t.get('text')) )
						+' ms. '
						+display_rules +' '
						+ $('angle').value +'º/'
						+$('wrap_angle_at').value
					);

					contentDisplay.set('value', lsys.content);
					generate.set('value','Generate Graph');
					generate.set('disabled', false);
					createMidi.set('value', 'Generate MIDI');
					createMidi.set('disabled', false);
					return false;
				});

				createMidi.addEvent('click', function(){
					createMidi.set('value', 'Hang on...');
					createMidi.set('disabled', true);
					createMIDIonServer(lsys);
				});
			});
		</script>

	</head>
 
	<body>
		<h1>L-systems in HTML5</h1>

		<nav>
			<a href='L0.html'>First L-System</a>
			|
			Parametric L-System
			|
			<a href='tests.html'>qUnit Tests</a>
		</nav>

		<form id='controls'>
			<div class='left'>
				<a name='ctrls'></a>
				<fieldset><legend id='title'>Loading</legend>
				<p>
					<label class='long' for='variables'>Constants <small><code>#define name value</code> &mdash; one per line</small></label>
					<textarea id='variables'></textarea>
				</p>
				<p>
					<label class='long' for='rules'>
						Rules
						<small><code>F(x,y): x==1 && y==2 => F+F-f</code> &mdash; one rule per line; <b>F</b>orward, <b>+</b> up, <b>-</b>down, <b>R</b> rest
					</small></label>
					<textarea id='rules' onChange='preview()'></textarea>
				</p>
				<p>
					<label for='start' class='long'>Axiom (seed)</label>
					<textarea id='start' onChange='preview()'></textarea>
				</p>
				<p>
					<label for='angle'>Angle</label>
					<span class='mooknob knob' id='angle-knob'
						aria-valuemin='0'
						aria-valuemax='360'
						data-monitor='angle'
						data-oncomplete='preview()'
					></span>
					<input type='text' id='angle' value='' />

					<label for='wrap_angle_at'>Wrap angle value at</label>
					<span class='mooknob knob' id='wrap-angle-knob'
						aria-valuemin='0'
						aria-valuemax='360'
						data-monitor='wrap_angle_at'
						data-oncomplete='preview()'
					></span>
					<input type='text' id='wrap_angle_at' value='' />

					<label for='generations'>Generations</label>
					<span class='mooknob knob' id='generations-knob'
						data-monitor='generations'
						aria-valuemin='1'
						aria-valuemax='20'
						data-scale='0.1'
						data-forceint='true'
					></span>
					<input type='text' id='generations' value=''/>
				</p>
				</fieldset>

				<fieldset><legend>MIDI</legend>
				<table>
					<tr>
						<th><label for='duration'>Note duration</label></th>
						<th><label for='scale'>Scale</label></th>
						<th>Preview</th>
					</tr>
					<tr style='height:100px'>
						<td>
							<span class='mooknob knob' id='duration-knob'
								style='margin-left:18pt'
								data-monitor='duration'
								data-scale='0.1'
								aria-valuemin='1'
								aria-valuemax='60'
								data-oncomplete='preview()'
							></span>
							<input  type='text' id='duration' value='48' />
						</td>
						<td>
							<select size=4 id='scale' onchange='preview()'>
								<option>pentatonic</option>
								<option>phrygian</option>
								<option>fifths</option>
								<option>magyar</option>
							</select>
						</td>
						<td>
							<a href='#ctrls' onclick='playSound("/cgi-output/cgi.midi")'>
								<span id='preview'></span>
							</a>
						</td>
					</tr>
				</table>

				<fieldset>
				<legend>
					<label for='bracket_callback'>Bracket callback</label>
				</legend>
					<pre style='margin:0; padding:0'>#!/usr/bin/perl
# $note and $duration are preset decimal integers
# Alter the above, or set $rv to the value by which to adjust $note.
my ($self, $variables, $content, $place) = @_;
# Lsys::MIDI, @$bracketd_vars, @$content, $index_in_content
my $rv;
eval {</pre>
					<textarea  style='margin:0; padding:0'id='bracket_callback' name='bracket_callback'></textarea>
<pre style='margin:0; padding:0'>}
return $rv; </pre>
				</fieldset>
			</fieldset>
		</div>

		<div class='right'>
				<fieldset><legend>Presets</legend>
					<ul id='presets'></ul>
				</fieldset>
				<label for='contentDisplay'>Commands output</label>
				<textarea id='contentDisplay'></textarea>

				<fieldset class='small'><legend>Visual settings</legend>
				<p>
					<label for='canvas_width'>Canvas width</label>
					<span class='mooknob knob' id='canvas-width-knob'
						data-monitor='canvas_width'
						data-scale='0.5'
						aria-valuemin='100'
						aria-valuemax='2000'
					></span>
					<input type='text' id='canvas_width' value=''/>
					<label for='canvas_height'>Canvas height</label>
					<span class='mooknob knob' id='canvas-height-knob'
						data-monitor='canvas_height'
						data-scale='0.5'
						aria-valuemin='100'
						aria-valuemax='2000'
					></span>
					<input type='text' id='canvas_height' value=''/>

					<label for='init_x'>Init X</label>
					<input type='text' id='init_x' value=''/>
					<label for='init_y'>Init Y</label>
					<input type='text' id='init_y' value=''/>
				</p>

				<p>
					<label for='turtle_step_x'>Turtle Step X</label>
					<span class='mooknob knob' id='turtle_step_x-knob'
						data-monitor='turtle_step_x'
						data-scale='0.5'
						aria-valuemin='1'
						aria-valuemax='50'
					></span>
					<input type='text' id='turtle_step_x' value=''/>

					<label for='turtle_step_y'>Turtle Step Y</label>
					<span class='mooknob knob' id='turtle_step_y-knob'
						data-monitor='turtle_step_y'
						data-scale='0.5'
						aria-valuemin='1'
						aria-valuemax='50'
					></span>
					<input type='text' id='turtle_step_y' value=''/>

					<label for='line_width'>Line width</label>
					<span class='mooknob knob' id='line_width-knob'
						data-monitor='line_width'
						data-scale='0.5'
						aria-valuemin='1'
						aria-valuemax='20'
					></span>
					<input type='text' id='line_width' value=''/>
					<!--
					<label for'generations_scale_lines'>Scale lines with age?</label>
					<input type='checkbox' checked='true' name='generations_scale_lines' id='generations_scale_lines'/>
					-->
				</p>
				</fieldset>

				<fieldset class='submit'>
					<input type='button' id='generate' value='Generate'/>
					<input type='button' id='createMidi' value='Generate MIDI' disabled='true'/>
					<p>
						<iframe id='iplayer' src='jsplayer.html' height=20></iframe>
					<small>(Music on local laptop only)</small>
					</p>
					<p><pre class='errors' id='error'></pre></p>
				</fieldset>
			</div>
		</form>

		<div id='canvases'></div>
	</body>
</html>


